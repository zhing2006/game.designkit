---
description: 分析游戏设计文档的一致性、完整性和支柱对齐度
---

## 用户输入

```text
$ARGUMENTS
```

在继续之前，**必须**考虑用户输入（如果非空）。

## 目标

在实施前识别三个核心文档（`spec.md`、`plan.md`、`tasks.md`）之间的不一致、重复、歧义和欠规范项。本命令必须在 `/game.designkit.tasks` 成功生成完整的 `tasks.md` 之后运行。

## 操作约束

**严格只读**：不修改任何文件。输出结构化分析报告。提供可选的修复建议（用户必须明确批准后才能手动调用后续编辑命令）。

**设计支柱权威**：项目设计支柱（`.game.design/memory/pillars.md`）在此分析范围内不可协商。支柱冲突自动标记为 CRITICAL，需要调整 spec、plan 或 tasks，而非弱化、重新解释或忽略原则。如果支柱本身需要更改，必须在 `/game.designkit.analyze` 之外单独、明确地更新支柱文件。

## 执行步骤

### 1. 初始化分析上下文


从仓库根目录运行
  Windows: `.game.design/scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks`
  Linux or MacOS: `.game.design/scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks`
一次，并解析 JSON 获取 FEATURE_DIR 和 AVAILABLE_DOCS。推导绝对路径：

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

如果任何必需文件缺失，中止并显示错误消息（指导用户运行缺失的前置命令）。
对于参数中的单引号（如 "I'm Groot"），使用转义语法：'I'\''m Groot'（或使用双引号："I'm Groot"）。

### 2. 加载文档（渐进式披露）

仅加载每个文档的最小必要上下文：

**从 spec.md：**

- 概述/上下文
- 功能需求
- 非功能需求
- 用户故事
- 边缘情况（如有）

**从 plan.md：**

- 设计方法
- 设计产物清单
- 阶段
- 设计约束

**从 tasks.md：**

- 任务 ID
- 描述
- 阶段分组
- 并行标记 [P]
- 引用的文件路径

**从 pillars：**

- 加载 `.game.design/memory/pillars.md` 进行设计原则验证

### 3. 建立语义模型

创建内部表示（不在输出中包含原始文档）：

- **需求清单**：每个功能性+非功能性需求，带有稳定键（基于命令短语派生slug；例如，"用户可以上传文件" → `user-can-upload-file`）
- **用户故事/操作清单**：离散的用户操作及验收标准
- **任务覆盖映射**：将每个任务映射到一个或多个需求或故事（通过关键词/显式引用模式如 ID 或关键短语推断）
- **设计支柱规则集**：提取支柱名称和 MUST/SHOULD 规范性声明

### 4. 执行检测（高效分析）

聚焦高信号发现。限制最多 50 个发现；其余汇总到溢出摘要。

#### A. 重复检测

- 识别近似重复的需求
- 标记较低质量的表述以便合并

#### B. 歧义检测

- 标记模糊形容词（快速、可扩展、安全、直观、稳健）缺少可衡量标准
- 标记未解决的占位符（TODO、TKTK、???、`<placeholder>` 等）

#### C. 欠规范检测

- 需求有动词但缺少对象或可衡量结果
- 用户故事缺少验收标准对齐
- 任务引用 spec/plan 中未定义的文件或组件

#### D. 设计支柱对齐

- 任何需求或计划元素与支柱原则冲突
- 缺少支柱要求的章节或质量闸门

#### E. 覆盖缺口

- 需求无对应任务
- 任务无映射需求/故事
- **plan.md 中的设计产物在 tasks.md 中无对应的编写任务**（检查任务是否规划了产物编写，不检查产物文件是否已创建）
- 非功能需求未在任务中体现

**重要说明**：此阶段（tasks 生成后、实施前）检查的是任务规划的完整性，不是检查产物是否已创建。产物文档（docs/xxx/*.md）在实施阶段才会创建。

#### F. 不一致

- 术语漂移（同一概念在不同文件中命名不同）
- **规范类型与产物不匹配**（全局型规范生成功能型产物，或反之）
- 任务顺序矛盾（例如，先集成后基础，无依赖说明）
- 冲突的需求

### 5. 严重性分级

使用此启发式方法优先级排序发现：

- **CRITICAL**：违反设计支柱原则、缺少核心规范文档、需求零覆盖阻塞基线功能
- **HIGH**：重复或冲突需求、模糊的安全/性能属性、不可测试的验收标准
- **MEDIUM**：术语漂移、设计产物覆盖缺失、欠规范的边缘情况
- **LOW**：风格/措辞改进、小冗余不影响执行顺序

### 6. 生成紧凑分析报告

输出 Markdown 报告（不写入文件），结构如下：

## 规范分析报告

| ID | 类别 | 严重性 | 位置 | 摘要 | 建议 |
|----|------|--------|------|------|------|
| A1 | Duplication | HIGH | spec.md:L120-134 | 两个相似的需求... | 合并表述；保留更清晰的版本 |

（每个发现添加一行；生成稳定的 ID，以类别首字母作为前缀）

**重要**：只报告需要修复的问题。对齐正确、无问题的检查结果不应出现在问题表中，应该在成功摘要或指标部分体现。

**覆盖摘要表：**

| 需求键 | 有任务？ | 任务 ID | 备注 |
|--------|---------|---------|------|

**设计支柱对齐问题：**（如有）

**未映射任务：**（如有）

**指标：**

- 总需求数
- 总任务数
- 覆盖率 %（有 >=1 任务的需求）
- 歧义数
- 重复数
- 关键问题数

### 7. 提供下一步建议

在报告末尾，输出简洁的下一步行动块：

- 如果存在 CRITICAL 问题：建议在 `/game.designkit.implement` 之前解决
- 如果只有 LOW/MEDIUM：用户可以继续，但提供改进建议
- 提供明确的命令建议：例如，"运行 /game.designkit.specify 进行细化"、"运行 /game.designkit.plan 调整设计"、"手动编辑 tasks.md 为 '性能指标' 添加覆盖"

### 8. 提供修复建议

询问用户："是否需要我为前 N 个问题提供具体的修复编辑建议？"（不自动应用）

## 操作原则

### 上下文效率

- **最小高信号令牌**：聚焦可操作发现，而非详尽文档
- **渐进式披露**：增量加载文档；不转储所有内容到分析中
- **令牌高效输出**：限制发现表格为 50 行；汇总溢出
- **确定性结果**：无更改重新运行应产生一致的 ID 和计数

### 分析指南

- **绝不修改文件**（这是只读分析）
- **绝不臆造缺失章节**（如果缺失，准确报告）
- **优先处理设计支柱违规**（这些始终是 CRITICAL）
- **使用示例而非详尽规则**（引用具体实例，而非通用模式）
- **优雅报告零问题**（发出成功报告及覆盖统计）

## 上下文

$ARGUMENTS
